c=range
def p(s):
 F=len(s);l=len(s[0]);u=*a,=sum(s,[]);_=F*l;s=lambda j,i:_>i>=0<(e:=j[i])and sum((s(j,i+n)for n in[-1,-l,l,1][i%l<1:exec('j[i]=0')]),[(i,e)])or[]
 for n in c(_):
  if len(s(a,n))>3:
   k=s(u,n)
   for n in c(8):
    for w in c(-_,_):
     for i,e in all(e==u[(i+w)%_]for i,e in k if sum(e==z for z,z in k)<2)*k:u[(i+w)%_]=e
    k=[((i%l,F-i%l)[n!=3]*l+i//l-min(o//l for o,z in k),e)for i,e in k]
 return[*zip(*[iter(u)]*l)]